{"title":"Laravel后端问题整理","date":"2020-02-05T11:13:51.000Z","date_formatted":{"ll":"Feb 5, 2020","L":"02/05/2020","MM-DD":"02-05"},"link":"Learning/ab11027998a1","tags":["Laravel","PHP"],"categories":["Learning"],"updated":"2023-11-14T12:07:06.466Z","content":"<h2 id=\"php常用命令\">PHP常用命令<a title=\"#php常用命令\" href=\"#php常用命令\"></a></h2>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">php test.php          #运行文件</span><br><span class=\"line\">php -r &quot;phpinfo();&quot;   #运行语句</span><br><span class=\"line\">php -m                #内置和Zend加载模块</span><br><span class=\"line\">php -i                #phpinfo()</span><br><span class=\"line\">php -i | grep php.ini #查看php配置文件加载路径</span><br><span class=\"line\">php -i | grep -i extension_dir  #查看扩展加载路径</span><br><span class=\"line\">php –ini              #查看php配置文件加载路径 </span><br><span class=\"line\">php -v                #查看php版本 php –version</span><br><span class=\"line\">php –re xx            #查看是否安装相应的扩展：php –re gd</span><br><span class=\"line\">php –help             #更多命令</span><br></pre></td></tr></table></figure>\n<h2 id=\"composer源替换\">Composer源替换<a title=\"#composer源替换\" href=\"#composer源替换\"></a></h2>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">composer config -gl  #查看composer全局设置</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">替换源，以下几个任选一个</span></span><br><span class=\"line\">composer config -g repo.packagist composer https://packagist.phpcomposer.com</span><br><span class=\"line\">composer config -g repo.packagist composer https://mirrors.aliyun.com/composer</span><br></pre></td></tr></table></figure>\n<h2 id=\"laravel自动维护时间字段\">Laravel自动维护时间字段<a title=\"#laravel自动维护时间字段\" href=\"#laravel自动维护时间字段\"></a></h2>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//Migration</span></span><br><span class=\"line\"><span class=\"title class_\">Schema</span>::<span class=\"title function_ invoke__\">create</span>(<span class=\"string\">&#x27;users&#x27;</span>, function (Blueprint <span class=\"variable\">$table</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">//...省略</span></span><br><span class=\"line\">\t<span class=\"variable\">$table</span>-&gt;<span class=\"title function_ invoke__\">timestamps</span>();  <span class=\"comment\">//使关系表含有create_at和update_at字段</span></span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"><span class=\"comment\">//Model</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Users</span> <span class=\"keyword\">extends</span> <span class=\"title\">Model</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 可添加字段（白名单）</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"variable\">$fillable</span> = [<span class=\"string\">&#x27;name&#x27;</span>, <span class=\"string\">&#x27;sex&#x27;</span>];</span><br><span class=\"line\">    <span class=\"comment\">// 或者禁止某些字段（黑名单）</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"variable\">$guarded</span> = [<span class=\"string\">&#x27;uid&#x27;</span>];</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//Controller</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">PublicController</span> <span class=\"keyword\">extends</span> <span class=\"title\">Controller</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"title class_\">Users</span>::<span class=\"title function_ invoke__\">insert</span>();<span class=\"comment\">//这样是不会自动维护时间字段的</span></span><br><span class=\"line\">    <span class=\"comment\">//以下可实现自动维护字段</span></span><br><span class=\"line\">    <span class=\"variable\">$user</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">Users</span>(); <span class=\"comment\">//实例化user模型</span></span><br><span class=\"line\">    <span class=\"variable\">$user</span>-&gt;<span class=\"title function_ invoke__\">fillable</span>([<span class=\"string\">&#x27;name&#x27;</span>, <span class=\"string\">&#x27;sex&#x27;</span>]); <span class=\"comment\">//给模型指定可填充的字段。（也可以在模型中实现，见Model）</span></span><br><span class=\"line\">    <span class=\"variable\">$user</span>-&gt;<span class=\"title function_ invoke__\">fill</span>([<span class=\"string\">&#x27;name&#x27;</span>=&gt; <span class=\"string\">&#x27;Tom&#x27;</span>, <span class=\"string\">&#x27;sex&#x27;</span>=&gt;<span class=\"number\">1</span>]); <span class=\"comment\">//给实例填充数据，数据字段必须包含在fillable里</span></span><br><span class=\"line\">    <span class=\"variable\">$user</span>-&gt;<span class=\"title function_ invoke__\">save</span>(); <span class=\"comment\">//保存到数据库</span></span><br><span class=\"line\">    <span class=\"variable\">$user</span>-&gt;id; <span class=\"comment\">//获取自增字段的id</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"laravel自定义全局公用函数\">Laravel自定义全局公用函数<a title=\"#laravel自定义全局公用函数\" href=\"#laravel自定义全局公用函数\"></a></h2>\n<ul>\n<li>首先在app下新建一个文件夹Lib，用于放公共函数的php文件，如我建的</li>\n</ul>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"comment\">//当前路径：app\\Lib\\functions.php</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* 格式化api返回</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">returnData</span>(<span class=\"params\"><span class=\"variable\">$isSuccess</span>, <span class=\"variable\">$msg</span>, <span class=\"variable\">$data</span></span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> [</span><br><span class=\"line\">        <span class=\"string\">&#x27;isSuccess&#x27;</span> =&gt; <span class=\"variable\">$isSuccess</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;msg&#x27;</span> =&gt; <span class=\"variable\">$msg</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;data&#x27;</span> =&gt; <span class=\"variable\">$data</span></span><br><span class=\"line\">    ];</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>在根目录下，打开composer.json，找到autoload，在其中增加files，如：</li>\n</ul>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">&quot;autoload&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;psr-4&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;App\\\\&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;app/&quot;</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;classmap&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">        <span class=\"string\">&quot;database/seeds&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"string\">&quot;database/factories&quot;</span></span><br><span class=\"line\">    <span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;files&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">        <span class=\"string\">&quot;app/Lib/functions.php&quot;</span></span><br><span class=\"line\">    <span class=\"punctuation\">]</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>在终端，执行自动加载命令，即可生效在任何地方直接使用了</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">composer dump-autoload</span><br></pre></td></tr></table></figure>\n<h2 id=\"laravel项目修改时区\">Laravel项目修改时区<a title=\"#laravel项目修改时区\" href=\"#laravel项目修改时区\"></a></h2>\n<p>通常默认安装后，项目的时区不是中国的时区，导致自动维护字段等涉及到时间问题，总是和我们时间相差8小时，这里就需要配置时区了。</p>\n<ul>\n<li>打开app.php，找到’timezone’ =&gt; ‘UTC’</li>\n</ul>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">&#x27;timezone&#x27;</span> =&gt; <span class=\"string\">&#x27;UTC&#x27;</span>,   <span class=\"comment\">//原来的默认设置</span></span><br><span class=\"line\"><span class=\"string\">&#x27;timezone&#x27;</span> =&gt; <span class=\"title function_ invoke__\">env</span>(<span class=\"string\">&#x27;TIMEZONE&#x27;</span>,<span class=\"string\">&#x27;UTC&#x27;</span>),   <span class=\"comment\">//修改为这样，通过.env文件配置</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>打开.env，添加一行</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TIMEZONE=Asia/Shanghai</span><br></pre></td></tr></table></figure>\n<h2 id=\"laravel数据库事务\">Laravel数据库事务<a title=\"#laravel数据库事务\" href=\"#laravel数据库事务\"></a></h2>\n<ul>\n<li>自动：第一个参数为需要进行的数据库操作，第二个参数定义发生死锁时最大的重试次数</li>\n</ul>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DB::<span class=\"title function_ invoke__\">transaction</span>(function () &#123;</span><br><span class=\"line\">    <span class=\"comment\">//...</span></span><br><span class=\"line\">    <span class=\"comment\">//需要执行的一系列数据库操作</span></span><br><span class=\"line\">    <span class=\"comment\">//...</span></span><br><span class=\"line\">&#125;, <span class=\"number\">5</span>);</span><br></pre></td></tr></table></figure>\n<ul>\n<li>手动使用事务</li>\n</ul>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">try</span>&#123;</span><br><span class=\"line\">    DB::<span class=\"title function_ invoke__\">beginTransaction</span>();</span><br><span class=\"line\">    <span class=\"comment\">//...</span></span><br><span class=\"line\">    <span class=\"comment\">//需要执行的一系列数据库操作</span></span><br><span class=\"line\">    <span class=\"comment\">//...</span></span><br><span class=\"line\">    DB::<span class=\"title function_ invoke__\">commit</span>();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">catch</span>&#123;</span><br><span class=\"line\">    DB::<span class=\"title function_ invoke__\">rollBack</span>();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\".env配置了但无法读取数据\">.env配置了但无法读取数据<a title=\"#.env配置了但无法读取数据\" href=\"#.env配置了但无法读取数据\"></a></h2>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">php artisan cache:clear</span><br><span class=\"line\">php artisan config:clear</span><br></pre></td></tr></table></figure>\n<h2 id=\"无法访问public下的资源文件\">无法访问public下的资源文件<a title=\"#无法访问public下的资源文件\" href=\"#无法访问public下的资源文件\"></a></h2>\n<blockquote>\n<p><a href=\"https://laracasts.com/discuss/channels/laravel/my-css-fails-to-load-when-using-php-artisan-serve-to-host-on-my-computer\">https://laracasts.com/discuss/channels/laravel/my-css-fails-to-load-when-using-php-artisan-serve-to-host-on-my-computer</a></p>\n</blockquote>\n<p>更换启动方式：<code>php -S localhost:8000 -t public</code></p>\n","prev":{"title":"Laravel常用命令","link":"Learning/05e70c5ba457"},"next":{"title":"Nginx用certbot获取Let's Encrypt SSL证书","link":"Learning/97cad6591dc5"},"plink":"https://blog.jschef.com/Learning/ab11027998a1/","toc":[{"id":"php常用命令","title":"PHP常用命令","index":"1"},{"id":"composer源替换","title":"Composer源替换","index":"2"},{"id":"laravel自动维护时间字段","title":"Laravel自动维护时间字段","index":"3"},{"id":"laravel自定义全局公用函数","title":"Laravel自定义全局公用函数","index":"4"},{"id":"laravel项目修改时区","title":"Laravel项目修改时区","index":"5"},{"id":"laravel数据库事务","title":"Laravel数据库事务","index":"6"},{"id":".env配置了但无法读取数据","title":".env配置了但无法读取数据","index":"7"},{"id":"无法访问public下的资源文件","title":"无法访问public下的资源文件","index":"8"}],"reward":true,"copyright":{"author":"Chef Wu","link":"<a href=\"https://blog.jschef.com/Learning/ab11027998a1/\" title=\"Laravel后端问题整理\">https://blog.jschef.com/Learning/ab11027998a1/</a>","license":"自由转载-非商用-禁止演绎-保持署名 (<a href=\\\"https://creativecommons.org/licenses/by-nc-sa/4.0/\\\" rel=\\\"external nofollow\\\" target=\\\"_blank\\\">CC BY-NC-ND 4.0</a>)","published":"February 5, 2020"}}