{"title":"毕业设计-“跑鸭”微信小程序","date":"2020-06-17T01:13:40.000Z","date_formatted":{"ll":"Jun 17, 2020","L":"06/17/2020","MM-DD":"06-17"},"link":"Learning/3029bde5b8fc","tags":["Mysql"],"categories":["Learning"],"updated":"2023-11-14T12:07:06.466Z","content":"<p>这是我的毕业设计：一款基于校园运动的社交小程序</p>\n<p>功能：跑步 + “仿朋友圈” + 在线活动</p>\n<p>技术栈：前端 JS / Less / Vant-Weapp / Iview-Weapp、后端 PHP7 / Laravel / MySQL</p>\n<span id=\"more\"></span>\n<h2 id=\"一、写前bb\">一、写前BB<a title=\"#一、写前bb\" href=\"#一、写前bb\"></a></h2>\n<p>毕业设计我有两个想法，另外一个是人生经验树想法，难点在于UI的设计，通过技术调研发现echarts是无法实现的，只能通过D3，我对于交互美化这块在指定时间内能完成心里没有个底，所以放弃了那个想法。下面是这个想法的具体内容：</p>\n<details>\n<summary>点击查看我另一个想法</summary>\n<p>人一生会经历很多选择，不同人选择走不同的路因此有了不同的人生。<br>\n我想做一个大家可以共同参与编辑的一个颗人生经验树，以某个时间点为根，按照自己选择的方向建立分支；<br>\n在支点填下自己选择的理由，在枝丫上记录之后的学习经验或者失败经验；<br>\n之后在下一次新的选择时，就在这个枝丫上建立分支，依次细分下去；<br>\n这样可以为以后有做出同样选择的人参考，看看部分成功人士的每一次选择以及做法，也可以记录自己的成长，导出自传。</p>\n<p>程序分三大块：世界经验树、个人经历时间轴、个人中心<br>\n（1）世界经验树(类似地图设计)：<br>\n一棵大树，展现部分枝丫，枝丫尖展现点赞和评论较多的人名。可以放大查看，即展现视区点赞较高的人；<br>\n个人快速定位，可进行编辑分支；<br>\n顶部关键词搜索，查看想看的人的人生轨迹；<br>\n（2）个人经历时间轴：供自己参考个人历史，让自己时常反思<br>\n（3）个人中心：设置</p>\n<p>难点：UI交互、数据库设计</p>\n</details>\n<p>最终选择的这个想法是在我大二的时候就有的了，就是做一款跑步程序，难点在于任务量太多（事实证明，工作量确实大，大概花了3个月实现，期间还有一个小姐姐帮我分担了两个页面）。</p>\n<h2 id=\"二、功能设计\">二、功能设计<a title=\"#二、功能设计\" href=\"#二、功能设计\"></a></h2>\n<p>”跑鸭“微信小程序的核心功能就是：跑步+社交+活动，详细划分如下：</p>\n<p>（1）跑步（首屏）：当前位置地图、排行榜（周榜、月榜）、运动路径、实时数据（里程、配速）、随机一言。</p>\n<p>（2）动态圈子：打卡分享、发布分享、热门推荐、点赞评论、消息通知。</p>\n<p>（3）活动广场：线上活动（报名、完赛条件、奖励）、跑步教程。</p>\n<p>（4）个人中心：运动管理、动态管理、设置（通用设置、隐私设置）、勋章墙、等级称号、个人主页、资料编辑。</p>\n<h2 id=\"三、数据库设计\">三、数据库设计<a title=\"#三、数据库设计\" href=\"#三、数据库设计\"></a></h2>\n<p>根据功能分析，一共规划出11个实体，形成<strong>E-R图</strong>：</p>\n<p><img src=\"../images/20200618185938.jpg\" alt=\"image\" class=\"φbs\"></p>\n<p>由E-R图，共转换成16张表（每张表均含有创建时间和更新时间，以下没有列出）：</p>\n<details>\n<summary>展开查看详细列表</summary>\n<p>（1）用户表（r_users）：（编号（主键）,微信openid，昵称，校区，性别，头像，职业，个人签名）；<br>\n（2）运动记录表（r_runs）：（编号（主键），用户编号（外键），里程，卡路里，最高配速，最低配速，平均配速，开始时间，结束时间，运动时间，起点维度，起点经度，终点经度，终点维度，分享）；<br>\n（3）称号表（r_honors）：（编号（主键），称号描述，称号名称）；<br>\n（4）勋章表（r_medals）：（编号（主键），标识符，类型，名称，简介，图标）；<br>\n（5）动态表（r_moments）：（编号（主键），用户编号（外键），动态内容，动态类型，动态位置，位置经度，位置维度）；<br>\n（6）活动表（r_activitys）：（编号（主键），勋章编号（外键），封面图编号（外键），标题，简述，活动内容，达成条件，截止时间）；<br>\n（7）教程表（r_courses）：（编号（主键），标题，内容）；<br>\n（8）隐私设置表（r_settings）：（用户编号（外键），职业设置，校区设置，运动设置）；<br>\n（9）系统信息表（r_notices）：（编号（主键），发出者编号（外键），接收者编号（外键），类型，已读，内容）；<br>\n（10）图片表（images）：（编号（主键），标识符，标识编号，原名称，存储名称，后缀，图片格式，大小，宽，高，压缩宽，压缩高，原图地址，压缩图地址，压缩错误码）；<br>\n（11）称号获得表（link_u_hs）：（用户编号（外键），称号编号（外键））；<br>\n（12）勋章获得表（link_u_ms）：（编号（主键），用户编号（外键），勋章编号（外键））；<br>\n（13）点赞表（link_u_like_ms）：（动态编号（外键），用户编号（外键））；<br>\n（14）评论表（comments）：（编号（主键），用户编号（外键），动态编号（外键），评论内容）；<br>\n（15）活动参加表（link_u_as）：（用户编号（外键），活动编号（外键），完成）；<br>\n（16）每日一言（hitokotos）：（一言编号（主键），类型，来源，作者）；</p>\n</details>\n<p><strong>数据模型图</strong>：</p>\n<p><img src=\"../images/20200618191037.jpg\" alt=\"image\" class=\"φbs\"></p>\n<h2 id=\"四、开发前的准备\">四、开发前的准备<a title=\"#四、开发前的准备\" href=\"#四、开发前的准备\"></a></h2>\n<h3 id=\"4.1-技术调研\">4.1 技术调研<a title=\"#4.1-技术调研\" href=\"#4.1-技术调研\"></a></h3>\n<p><strong>前端</strong>：</p>\n<p>没商量，使用微信小程序开发（因为我要为我的其他项目去深入学习小程序开发），但是UI框架上从Vant、Wux和iView中最终选择了Vant为主（因为它比较规范）。</p>\n<blockquote>\n<p>但是可能最开始没有说清楚，那个小姐姐最开始使用的iView开发，为了减少任务量，使用的iView那块继续保持着，没有替换成Vant</p>\n</blockquote>\n<p><strong>后端</strong>：</p>\n<p>后端我考虑了node+MongoDB、Java+MySQL、PHP+MySQL三种。</p>\n<p>我首先考虑的是node开发，先去考察了node的框架：express、koa、koa2、egg，最终选择了koa2学习。</p>\n<p>我首先看了一遍<a href=\"https://www.liaoxuefeng.com/wiki/1022910821149312/1023025235359040\" target=\"_blank\">廖雪峰老师写的node文章</a>，然后简单编写了一个请求的demo并成功部署到服务器，发现它的编写需要导入很多库，而且我不太清楚有哪些库，为了加一个token验证的库，我去koa的github上找了半天，也没有实现，所以放弃了。</p>\n<p>然后想了想Java，其实之前会的，但是我刚开始配置Java环境和配置Spring时就直接放弃了，<strong>配置太难搞了</strong>！！</p>\n<p>最后还是选择PHP吧，几乎不需要配置，然后框架使用的是大二一直没有学会的Laravel，我按照<a href=\"https://laravel.com/docs/6.x/installation\" target=\"_blank\">Laravel官网</a>的方法，直接安装了composer，使用最新的Laravel版本，学习是看的<a href=\"https://qianjinyike.com/category/laravel/\" target=\"_blank\">视频</a>，视频讲了个大概，更多的还是看的官网的文档（看不懂的时候才用的翻译）。</p>\n<p><strong>API管理</strong>：</p>\n<p>API管理是我在拓尔思实习的时候了解到一个<a href=\"https://github.com/YMFE/yapi\" target=\"_blank\">YApi平台</a>，公司那时还没有正式全面使用，前端这边就提了一下，但是我却下来认真研究了一下，并自己部署了一个，已经投入到自己的项目管理，给学弟托管大创接口。</p>\n<p><strong>产品原型</strong>：</p>\n<p>产品原型就相当于是开发前“打草稿”，我使用的是<a href=\"https://orgnext.modao.cc\" target=\"_blank\">墨刀</a>，主要是开发前期，对程序页面进行了大致绘制，防止在开发过程中太过随意发挥了。</p>\n<p><strong>开发手册</strong>：</p>\n<p>开发手册其实就是打算用来记录一些前公用方法、公共组件等，我使用的是<a href=\"https://www.yuque.com\" target=\"_blank\">语雀</a>，其实就是一个在线协作文档。（期间也就最开始记录了一下公共组件、js模块，后来就没怎么记录了，主要是没时间，其实那些公共的方法模块一时还能记住）</p>\n<h3 id=\"4.2-规范制定\">4.2 规范制定<a title=\"#4.2-规范制定\" href=\"#4.2-规范制定\"></a></h3>\n<p><strong>前端</strong>：</p>\n<p>（1）凡是能多次使用的方法均需放在<code>app.js</code>里，或者整理成模块放在<code>utils</code>目录下；</p>\n<p>（2）每个方法必须要有注释；</p>\n<p>（3）凡是能重复的使用的页面模块，均需写成组件，保存在<code>components</code>目录下，组件目录命名<code>xxx-xxx</code>，组件文件命名为<code>index</code>；</p>\n<p>（4）git提交：完成某个功能点，或者修复某个问题需要commit一次；</p>\n<p><strong>后端</strong>：</p>\n<p>（1）接口路由按模块分组，<code>api/run/a</code>，<code> api/run/b</code>；</p>\n<p>（2）git提交：完成一个接口提交一次，调整某些功能提交一次；</p>\n<p>（3）接口返回格式json：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&#x27;isSuccess&#x27;</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">  <span class=\"string\">&#x27;msg&#x27;</span>: <span class=\"string\">&#x27;操作成功&#x27;</span>,</span><br><span class=\"line\">  <span class=\"string\">&#x27;data&#x27;</span>: &#123;&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>（4）接口tag设置：</p>\n<ul>\n<li>未设置：还在开发中</li>\n<li>已部署：已同步至开发环境，前端可用</li>\n<li>已上线：同步至正式环境，测试和演示可用（前端也可用）</li>\n<li>暂不实现：因种种原因，暂不实现或后期实现</li>\n</ul>\n<h3 id=\"4.3-工具和环境\">4.3 工具和环境<a title=\"#4.3-工具和环境\" href=\"#4.3-工具和环境\"></a></h3>\n<p><strong>环境</strong>：</p>\n<p>PHP7.2，MySQL-8.0.19</p>\n<p><strong>前端</strong>：</p>\n<ul>\n<li>\n<p>微信开发者工具：用于运行和调试程序</p>\n</li>\n<li>\n<p>VS code：小程序编码</p>\n<ul>\n<li>安装<code>EasyLess</code>插件，编写<code>less</code>，导出后缀设置为<code>.wxss</code></li>\n<li>安装<code>wechat-snippet</code>插件，微信小程序代码快捷插入</li>\n</ul>\n</li>\n</ul>\n<p><strong>后端</strong>：</p>\n<ul>\n<li>\n<p>VS code：PHP编码</p>\n<ul>\n<li>安装<code>laravel-goto-controller</code>，快速跳转到控制器</li>\n<li>安装<code>Laravel Snippets</code>，语法提示</li>\n<li>安装<code>Laravel Artisan</code>，运行artisan命令</li>\n</ul>\n</li>\n<li>\n<p>Navicat Premium 15：数据库可视化管理，数据模型，<a href=\"http://www.xue51.com/soft/35163.html\" target=\"_blank\">激活</a></p>\n</li>\n</ul>\n<p><strong>绘图</strong>：</p>\n<ul>\n<li>Visio 2016：绘制E-R图，流程图</li>\n<li>Xmind8：功能梳理</li>\n</ul>\n<p><strong>论文</strong>：</p>\n<ul>\n<li>Word 2016</li>\n</ul>\n<h2 id=\"五、项目代码介绍\">五、项目代码介绍<a title=\"#五、项目代码介绍\" href=\"#五、项目代码介绍\"></a></h2>\n<h3 id=\"5.1-前端\">5.1 前端<a title=\"#5.1-前端\" href=\"#5.1-前端\"></a></h3>\n<h4 id=\"5.1.1-仓库地址\">5.1.1 仓库地址<a title=\"#5.1.1-仓库地址\" href=\"#5.1.1-仓库地址\"></a></h4>\n<p><a href=\"https://github.com/Chef5/PopRun\">https://github.com/Chef5/PopRun</a></p>\n<h4 id=\"5.1.2-目录结构\">5.1.2 目录结构<a title=\"#5.1.2-目录结构\" href=\"#5.1.2-目录结构\"></a></h4>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">├─.vscode           #VS Code配置，含&#x27;EasyLess&#x27;插件配置</span><br><span class=\"line\">├─components        #自定义公共组件</span><br><span class=\"line\">├─dist              #iVew-Weapp库</span><br><span class=\"line\">├─imgs              #图标、默认图片</span><br><span class=\"line\">├─pages</span><br><span class=\"line\">│  ├─run            #跑步（首页）</span><br><span class=\"line\">│  │  └─sharePage        #分享到动态圈子页</span><br><span class=\"line\">│  ├─moments        #动态圈子</span><br><span class=\"line\">│  │  ├─messages         #消息盒子</span><br><span class=\"line\">│  │  └─newMoment        #新建动态</span><br><span class=\"line\">│  ├─pub            #活动广场</span><br><span class=\"line\">│  │  ├─blockDetail      #教程详细</span><br><span class=\"line\">│  │  ├─blockMore        #教程列表</span><br><span class=\"line\">│  │  ├─listDetail       #活动详细</span><br><span class=\"line\">│  │  └─listMore         #活动列表</span><br><span class=\"line\">│  └─user           #个人中心</span><br><span class=\"line\">│      ├─edit            #个人资料编辑</span><br><span class=\"line\">│      ├─modals          #勋章墙</span><br><span class=\"line\">│      ├─myMoments       #我的动态</span><br><span class=\"line\">│      ├─myRuns          #我的运动</span><br><span class=\"line\">│      ├─privacy         #隐私设置</span><br><span class=\"line\">│      ├─setting         #通用设置</span><br><span class=\"line\">│      └─userPage        #个人主页</span><br><span class=\"line\">├─theme             #主题定制</span><br><span class=\"line\">├─utils             #公共模块</span><br><span class=\"line\">└─voice             #音频文件</span><br></pre></td></tr></table></figure>\n<h4 id=\"5.1.3-部分核心代码\">5.1.3 部分核心代码<a title=\"#5.1.3-部分核心代码\" href=\"#5.1.3-部分核心代码\"></a></h4>\n<p><strong>tabbar红点数字提示</strong>：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">   * 设置tabbar状态</span></span><br><span class=\"line\"><span class=\"comment\">   * index: 第几个tab，0~3</span></span><br><span class=\"line\"><span class=\"comment\">   * value: &#123; dot:boolean, number:number &#125;</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\"><span class=\"attr\">setTabbar</span>: <span class=\"keyword\">function</span>(<span class=\"params\">index, value</span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!value.<span class=\"property\">number</span>)&#123;</span><br><span class=\"line\">        wx.<span class=\"title function_\">removeTabBarBadge</span>(&#123; index &#125;)</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(value.<span class=\"property\">dot</span>)&#123;</span><br><span class=\"line\">            wx.<span class=\"title function_\">showTabBarRedDot</span>(&#123; index &#125;)</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">            wx.<span class=\"title function_\">hideTabBarRedDot</span>(&#123; index &#125;)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;  <span class=\"comment\">//设置数字</span></span><br><span class=\"line\">        wx.<span class=\"title function_\">setTabBarBadge</span>(&#123;</span><br><span class=\"line\">            index,</span><br><span class=\"line\">            <span class=\"attr\">text</span>: value.<span class=\"property\">number</span>+<span class=\"string\">&#x27;&#x27;</span>,</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>动态单多图处理</strong>：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">attached</span>: <span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">setData</span>(&#123;</span><br><span class=\"line\">        <span class=\"attr\">data</span>: that.<span class=\"property\">properties</span>.<span class=\"property\">moment</span>,</span><br><span class=\"line\">        <span class=\"attr\">user</span>: user</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">_initData</span>(that.<span class=\"property\">data</span>.<span class=\"property\">data</span>.<span class=\"property\">imgs</span>.<span class=\"property\">thumbnail</span>,that)</span><br><span class=\"line\">&#125;,</span><br><span class=\"line\"><span class=\"attr\">methods</span>: &#123;</span><br><span class=\"line\">    <span class=\"attr\">_initData</span>: <span class=\"function\">(<span class=\"params\">d,e</span>)=&gt;</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(d.<span class=\"property\">length</span> == <span class=\"number\">1</span>)&#123;</span><br><span class=\"line\">            e.<span class=\"title function_\">setData</span>(&#123;</span><br><span class=\"line\">                <span class=\"attr\">imageWidth</span>: <span class=\"title class_\">Math</span>.<span class=\"title function_\">floor</span>(d[<span class=\"number\">0</span>].<span class=\"property\">width</span>*<span class=\"number\">420</span>/d[<span class=\"number\">0</span>].<span class=\"property\">height</span>),</span><br><span class=\"line\">                <span class=\"attr\">imageHeight</span>: <span class=\"number\">420</span></span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">view</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;content-img&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 多图 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">view</span> </span></span><br><span class=\"line\"><span class=\"tag\">          <span class=\"attr\">wx:if</span>=<span class=\"string\">&quot;&#123;&#123;data.imgs.thumbnail.length &gt; 1&#125;&#125;&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">          <span class=\"attr\">class</span>=<span class=\"string\">&quot;image-wrap&quot;</span> </span></span><br><span class=\"line\"><span class=\"tag\">          <span class=\"attr\">wx:for</span>=<span class=\"string\">&quot;&#123;&#123;data.imgs.thumbnail&#125;&#125;&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">          <span class=\"attr\">wx:for-item</span>=<span class=\"string\">&quot;item&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">          <span class=\"attr\">wx:for-index</span>=<span class=\"string\">&quot;index&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">          <span class=\"attr\">wx:key</span>=<span class=\"string\">&quot;item&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">          <span class=\"attr\">style</span>=<span class=\"string\">&quot;width: calc(calc(100% / &#123;&#123;data.imgs.thumbnail.length &gt; 3 ? 3 : data.imgs.thumbnail.length&#125;&#125;) - 20rpx);&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">view</span> </span></span><br><span class=\"line\"><span class=\"tag\">              <span class=\"attr\">class</span>=<span class=\"string\">&quot;image&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">              <span class=\"attr\">catchtap</span>=<span class=\"string\">&quot;showBigimg&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">              <span class=\"attr\">data-url</span>=<span class=\"string\">&quot;&#123;&#123;data.imgs.original[index].url&#125;&#125;&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">              <span class=\"attr\">style</span>=<span class=\"string\">&quot;background-image:url(&#123;&#123;item.url&#125;&#125;);&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">view</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">view</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 单图 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">view</span> </span></span><br><span class=\"line\"><span class=\"tag\">          <span class=\"attr\">wx:if</span>=<span class=\"string\">&quot;&#123;&#123;data.imgs.thumbnail.length == 1&#125;&#125;&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">          <span class=\"attr\">class</span>=<span class=\"string\">&quot;image-wrap-single&quot;</span> </span></span><br><span class=\"line\"><span class=\"tag\">          <span class=\"attr\">catchtap</span>=<span class=\"string\">&quot;showBigimg&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">          <span class=\"attr\">data-url</span>=<span class=\"string\">&quot;&#123;&#123;data.imgs.original[0].url&#125;&#125;&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">          <span class=\"attr\">style</span>=<span class=\"string\">&quot;width:&#123;&#123;imageWidth&#125;&#125;rpx;height:&#123;&#123;imageHeight&#125;&#125;rpx;background-image:url(&#123;&#123;data.imgs.thumbnail[0].url&#125;&#125;);&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">view</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">view</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p><strong>分享图绘制</strong>：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/** </span></span><br><span class=\"line\"><span class=\"comment\"> * 绘制分享图 ：动态圈子&amp;右上角 500*400  朋友圈 500*600（加了200显示小程序码）</span></span><br><span class=\"line\"><span class=\"comment\"> * nodeID: canvas id</span></span><br><span class=\"line\"><span class=\"comment\"> * run: 运动数据  </span></span><br><span class=\"line\"><span class=\"comment\"> *      自定义背景：run.bg=Image或者run.color=&#123;from, to, direction:0-7左上角顺时针（）&#125;</span></span><br><span class=\"line\"><span class=\"comment\"> * iswx: 是否分享到朋友圈[可选]，默认false</span></span><br><span class=\"line\"><span class=\"comment\"> * user: 用户数据[可选](分享到朋友圈时需要)：小程序码 user.ercode=Image</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"title function_\">draw</span>(<span class=\"params\">nodeID, run, iswx, user</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!run)&#123;</span><br><span class=\"line\">        <span class=\"title class_\">Dialog</span>.<span class=\"title function_\">alert</span>(&#123;</span><br><span class=\"line\">            <span class=\"attr\">message</span>: <span class=\"string\">&#x27;数据异常&#x27;</span></span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolved, rejected</span>)=&gt;</span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">//画图</span></span><br><span class=\"line\">        <span class=\"title class_\">Share</span>.<span class=\"title function_\">getCanvasWX6B</span>(nodeID, <span class=\"variable language_\">this</span>).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">canvas</span>=&gt;</span>&#123;</span><br><span class=\"line\">            <span class=\"comment\">//分享背景图</span></span><br><span class=\"line\">            <span class=\"keyword\">let</span> bg = canvas.<span class=\"title function_\">createImage</span>();</span><br><span class=\"line\">            bg.<span class=\"property\">src</span> = <span class=\"string\">&#x27;../../imgs/default/sharebg.png&#x27;</span>;</span><br><span class=\"line\">            run.<span class=\"property\">bg</span> = bg;</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(iswx)&#123;</span><br><span class=\"line\">                <span class=\"comment\">//小程序码</span></span><br><span class=\"line\">                <span class=\"keyword\">let</span> ercode = canvas.<span class=\"title function_\">createImage</span>();</span><br><span class=\"line\">                ercode.<span class=\"property\">src</span> = <span class=\"string\">&#x27;../../imgs/ercode.jpg&#x27;</span>;</span><br><span class=\"line\">                user.<span class=\"property\">ercode</span> = ercode;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"title class_\">Share</span>.<span class=\"title function_\">makeShareImg</span>(canvas, run, iswx, user);</span><br><span class=\"line\">            <span class=\"built_in\">setTimeout</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span>(iswx) &#123;</span><br><span class=\"line\">                    <span class=\"title class_\">Share</span>.<span class=\"title function_\">getFileWX6B</span>(monID, <span class=\"variable language_\">this</span>, iswx).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">imgurl</span>=&gt;</span>&#123;</span><br><span class=\"line\">                        <span class=\"variable language_\">this</span>.<span class=\"title function_\">setData</span>(&#123; <span class=\"attr\">monImg</span>: imgurl &#125;);</span><br><span class=\"line\">                    &#125;)</span><br><span class=\"line\">                &#125;<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    <span class=\"title class_\">Share</span>.<span class=\"title function_\">getFileWX6B</span>(nonID, <span class=\"variable language_\">this</span>, iswx).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">imgurl</span>=&gt;</span>&#123;</span><br><span class=\"line\">                        <span class=\"variable language_\">this</span>.<span class=\"title function_\">setData</span>(&#123; <span class=\"attr\">nonImg</span>: imgurl &#125;);</span><br><span class=\"line\">                    &#125;)</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;,<span class=\"number\">300</span>) <span class=\"comment\">//延迟防止绘制未完成</span></span><br><span class=\"line\">            <span class=\"title function_\">resolved</span>(canvas);</span><br><span class=\"line\">        &#125;).<span class=\"title function_\">catch</span>(<span class=\"function\"><span class=\"params\">err</span>=&gt;</span>&#123;</span><br><span class=\"line\">            <span class=\"title function_\">rejected</span>(err);</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"5.2-后端\">5.2 后端<a title=\"#5.2-后端\" href=\"#5.2-后端\"></a></h3>\n<h4 id=\"5.2.1-仓库地址\">5.2.1 仓库地址<a title=\"#5.2.1-仓库地址\" href=\"#5.2.1-仓库地址\"></a></h4>\n<p><a href=\"https://github.com/Chef5/PopRun-b\">https://github.com/Chef5/PopRun-b</a></p>\n<h4 id=\"5.2.2-目录结构\">5.2.2 目录结构<a title=\"#5.2.2-目录结构\" href=\"#5.2.2-目录结构\"></a></h4>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">├─.vscode               #VS Code配置</span><br><span class=\"line\">├─app                   #app目录</span><br><span class=\"line\">│  ├─Console                #【核心】控制台：定时任务</span><br><span class=\"line\">│  │  └─Commands                #命令：定时任务要执行的操作</span><br><span class=\"line\">│  ├─Exceptions         #异常抛出类</span><br><span class=\"line\">│  ├─Http               #Http控制</span><br><span class=\"line\">│  │  ├─Controllers         #【核心】控制器</span><br><span class=\"line\">│  │  │  └─Auth                 #控制器里进行分类：认证</span><br><span class=\"line\">│  │  └─Middleware      #中间件：过滤请求和响应</span><br><span class=\"line\">│  ├─Lib                #公共方法：主要写了一个返回参数格式化</span><br><span class=\"line\">│  └─Providers\t\t\t</span><br><span class=\"line\">├─config                #配置文件：主要改了数据库编码配置，支持emoji</span><br><span class=\"line\">├─database              #数据库</span><br><span class=\"line\">│  ├─factories</span><br><span class=\"line\">│  ├─migrations             #【核心】数据库迭代生成</span><br><span class=\"line\">│  └─seeds</span><br><span class=\"line\">├─public                #公共资源</span><br><span class=\"line\">│  ├─css</span><br><span class=\"line\">│  ├─js</span><br><span class=\"line\">│  ├─layui                  #layui引入</span><br><span class=\"line\">│  └─resources              #资源</span><br><span class=\"line\">│      ├─images                 #图片</span><br><span class=\"line\">│      │  ├─2020-01-31              #图片按上传日期分目录管理</span><br><span class=\"line\">│      ├─medals                 #勋章图片</span><br><span class=\"line\">│      └─userImgs               #用户头像</span><br><span class=\"line\">├─resources</span><br><span class=\"line\">├─routes                #【核心】路由</span><br><span class=\"line\">├─storage</span><br><span class=\"line\">├─tests</span><br><span class=\"line\">└─vendor                #Laravel依赖</span><br></pre></td></tr></table></figure>\n<h4 id=\"5.2.3-部分核心代码\">5.2.3 部分核心代码<a title=\"#5.2.3-部分核心代码\" href=\"#5.2.3-部分核心代码\"></a></h4>\n<p><strong>排行榜</strong>：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/** </span></span><br><span class=\"line\"><span class=\"comment\"> * 获取排行榜：周榜，月榜合并接口 type:0周榜 1月榜</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getRanking</span>(<span class=\"params\">Request <span class=\"variable\">$request</span></span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"variable\">$request</span>-&gt;<span class=\"title function_ invoke__\">has</span>(<span class=\"string\">&#x27;team&#x27;</span>))&#123;</span><br><span class=\"line\">        <span class=\"comment\">//默认月榜</span></span><br><span class=\"line\">        <span class=\"variable\">$timeStart</span> = <span class=\"title function_ invoke__\">date</span>(<span class=\"string\">&quot;Y-m-01&quot;</span>).<span class=\"string\">&quot; 00:00:00&quot;</span>;</span><br><span class=\"line\">        <span class=\"variable\">$timeEnd</span> = <span class=\"title function_ invoke__\">date</span>(<span class=\"string\">&#x27;Y-m-d&#x27;</span>, <span class=\"title function_ invoke__\">strtotime</span>(<span class=\"string\">&quot;<span class=\"subst\">$timeStart</span> +1 month -1 day&quot;</span>)).<span class=\"string\">&quot; 23:59:59&quot;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"variable\">$request</span>-&gt;<span class=\"title function_ invoke__\">has</span>(<span class=\"string\">&#x27;type&#x27;</span>) &amp;&amp; <span class=\"variable\">$request</span>-&gt;type == <span class=\"number\">0</span>)&#123;  <span class=\"comment\">//0周榜</span></span><br><span class=\"line\">            <span class=\"variable\">$timeStart</span> = <span class=\"title function_ invoke__\">date</span>(<span class=\"string\">&#x27;Y-m-d&#x27;</span>, <span class=\"title function_ invoke__\">strtotime</span>(<span class=\"string\">&quot;this week&quot;</span>)).<span class=\"string\">&quot; 00:00:00&quot;</span>;</span><br><span class=\"line\">            <span class=\"variable\">$timeEnd</span> = <span class=\"title function_ invoke__\">date</span>(<span class=\"string\">&#x27;Y-m-d&#x27;</span>, <span class=\"title function_ invoke__\">strtotime</span>(<span class=\"string\">&quot;+1 week -1 day&quot;</span>, <span class=\"title function_ invoke__\">strtotime</span>(<span class=\"string\">&quot;this week&quot;</span>))).<span class=\"string\">&quot; 23:59:59&quot;</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"variable\">$top100</span> = <span class=\"title class_\">RRuns</span>::<span class=\"title function_ invoke__\">join</span>(<span class=\"string\">&#x27;r_users&#x27;</span>, <span class=\"string\">&#x27;r_users.rid&#x27;</span>, <span class=\"string\">&#x27;=&#x27;</span>, <span class=\"string\">&#x27;r_runs.rid&#x27;</span>)</span><br><span class=\"line\">                -&gt;<span class=\"title function_ invoke__\">where</span>(<span class=\"string\">&#x27;r_users.team&#x27;</span>, <span class=\"variable\">$request</span>-&gt;team)</span><br><span class=\"line\">                -&gt;<span class=\"title function_ invoke__\">where</span>(<span class=\"string\">&#x27;r_runs.distance&#x27;</span>, <span class=\"string\">&#x27;&lt;&gt;&#x27;</span>, <span class=\"literal\">null</span>) <span class=\"comment\">//排除未完成运动</span></span><br><span class=\"line\">                -&gt;<span class=\"title function_ invoke__\">whereBetween</span>(<span class=\"string\">&#x27;r_runs.created_at&#x27;</span>, [<span class=\"variable\">$timeStart</span>, <span class=\"variable\">$timeEnd</span>])</span><br><span class=\"line\">                -&gt;<span class=\"title function_ invoke__\">select</span>(</span><br><span class=\"line\">                DB::<span class=\"title function_ invoke__\">raw</span>(</span><br><span class=\"line\">                    <span class=\"string\">&#x27;r_users.rid, </span></span><br><span class=\"line\"><span class=\"string\">                    r_users.nickname, </span></span><br><span class=\"line\"><span class=\"string\">                    r_users.img, </span></span><br><span class=\"line\"><span class=\"string\">                    r_users.team, </span></span><br><span class=\"line\"><span class=\"string\">                    cast(sum(r_runs.distance) as decimal(15,2)) as sumD,</span></span><br><span class=\"line\"><span class=\"string\">                    sum(r_runs.time_run) as sumT, </span></span><br><span class=\"line\"><span class=\"string\">                    cast(avg(r_runs.speed) as decimal(15,2)) as avgS&#x27;</span></span><br><span class=\"line\">                ))</span><br><span class=\"line\">                -&gt;<span class=\"title function_ invoke__\">groupBy</span>(<span class=\"string\">&#x27;r_runs.rid&#x27;</span>)</span><br><span class=\"line\">                -&gt;<span class=\"title function_ invoke__\">orderBy</span>(<span class=\"string\">&#x27;sumD&#x27;</span>, <span class=\"string\">&#x27;desc&#x27;</span>)</span><br><span class=\"line\">                -&gt;<span class=\"title function_ invoke__\">limit</span>(<span class=\"number\">100</span>)</span><br><span class=\"line\">                -&gt;<span class=\"title function_ invoke__\">get</span>();</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">returnData</span>(<span class=\"literal\">true</span>, <span class=\"string\">&quot;操作成功&quot;</span>, <span class=\"variable\">$top100</span>-&gt;<span class=\"title function_ invoke__\">toArray</span>());</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (\\<span class=\"built_in\">Throwable</span> <span class=\"variable\">$th</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">returnData</span>(<span class=\"literal\">false</span>, <span class=\"variable\">$th</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">returnData</span>(<span class=\"literal\">false</span>, <span class=\"string\">&#x27;缺少team校区&#x27;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>单次里程成就</strong>和<strong>活动成就</strong>检测：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 单次里程成就：5km, 10km, 15km, 20km, 半马(21.0975=21.09), 全马(42.195=42.19), 50km, 100km</span></span><br><span class=\"line\"><span class=\"comment\"> * 活动成就：r_activitys.distance</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">checkMedals</span>(<span class=\"params\"><span class=\"variable\">$rid</span>, <span class=\"variable\">$distance</span></span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 单次里程成就</span></span><br><span class=\"line\">    <span class=\"variable\">$distances</span> = [<span class=\"number\">5</span>, <span class=\"number\">10</span>, <span class=\"number\">15</span>, <span class=\"number\">20</span>, <span class=\"number\">21.09</span>, <span class=\"number\">42.19</span>, <span class=\"number\">50</span>, <span class=\"number\">100</span>];</span><br><span class=\"line\">    <span class=\"variable\">$medalkeys</span> = [<span class=\"string\">&#x27;star_1_act&#x27;</span>,<span class=\"string\">&#x27;star_2_act&#x27;</span>,<span class=\"string\">&#x27;star_3_act&#x27;</span>,<span class=\"string\">&#x27;star_4_act&#x27;</span>,<span class=\"string\">&#x27;star_5_act&#x27;</span>,<span class=\"string\">&#x27;star_6_act&#x27;</span>,<span class=\"string\">&#x27;star_7_act&#x27;</span>,<span class=\"string\">&#x27;star_8_act&#x27;</span>];</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"variable\">$distance</span>&gt;=<span class=\"number\">5</span>)&#123;</span><br><span class=\"line\">        <span class=\"variable\">$index</span> = <span class=\"number\">0</span>;  <span class=\"comment\">//</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span>(<span class=\"variable\">$i</span>=<span class=\"number\">0</span>; <span class=\"variable\">$i</span>&lt;<span class=\"title function_ invoke__\">count</span>(<span class=\"variable\">$distances</span>); <span class=\"variable\">$i</span>++)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(<span class=\"variable\">$distance</span>&gt;=<span class=\"variable\">$distances</span>[<span class=\"variable\">$i</span>]) <span class=\"variable\">$index</span> = <span class=\"variable\">$i</span>;</span><br><span class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"variable\">$medal</span> = <span class=\"title class_\">RMedals</span>::<span class=\"title function_ invoke__\">where</span>(<span class=\"string\">&#x27;mkey&#x27;</span>, <span class=\"variable\">$medalkeys</span>[<span class=\"variable\">$index</span>])-&gt;<span class=\"title function_ invoke__\">first</span>();</span><br><span class=\"line\">        <span class=\"variable\">$isAchieved</span> = <span class=\"title class_\">LinkUMs</span>::<span class=\"title function_ invoke__\">where</span>(<span class=\"string\">&#x27;rid&#x27;</span>, <span class=\"variable\">$rid</span>)-&gt;<span class=\"title function_ invoke__\">where</span>(<span class=\"string\">&#x27;meid&#x27;</span>, <span class=\"variable\">$medal</span>-&gt;meid)-&gt;<span class=\"title function_ invoke__\">get</span>();</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"title function_ invoke__\">count</span>(<span class=\"variable\">$isAchieved</span>)==<span class=\"number\">0</span>)&#123;  <span class=\"comment\">//未获取过，可以进行授予</span></span><br><span class=\"line\">            <span class=\"variable\">$me</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">LinkUMs</span>();</span><br><span class=\"line\">            <span class=\"variable\">$me</span>-&gt;<span class=\"title function_ invoke__\">fill</span>([</span><br><span class=\"line\">                <span class=\"string\">&#x27;rid&#x27;</span> =&gt; <span class=\"variable\">$rid</span>,</span><br><span class=\"line\">                <span class=\"string\">&#x27;meid&#x27;</span> =&gt; <span class=\"variable\">$medal</span>-&gt;meid</span><br><span class=\"line\">            ]);</span><br><span class=\"line\">            <span class=\"variable\">$me</span>-&gt;<span class=\"title function_ invoke__\">save</span>();</span><br><span class=\"line\">            <span class=\"title class_\">System</span>::<span class=\"title function_ invoke__\">systemNotice</span>([</span><br><span class=\"line\">                <span class=\"string\">&#x27;to&#x27;</span> =&gt; <span class=\"variable\">$rid</span>, </span><br><span class=\"line\">                <span class=\"string\">&#x27;msg&#x27;</span> =&gt; <span class=\"string\">&quot;你新获得一枚勋章&lt;&quot;</span>.<span class=\"variable\">$medal</span>-&gt;name.<span class=\"string\">&quot;&gt;&quot;</span></span><br><span class=\"line\">            ]);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 活动成就</span></span><br><span class=\"line\">    <span class=\"variable\">$timeNow</span> = <span class=\"title function_ invoke__\">date</span>(<span class=\"string\">&#x27;Y-m-d H:i:s&#x27;</span>);</span><br><span class=\"line\">    <span class=\"variable\">$theLastestFinished</span> = <span class=\"title class_\">LinkUAs</span>::<span class=\"title function_ invoke__\">join</span>(<span class=\"string\">&#x27;r_activitys&#x27;</span>, <span class=\"string\">&#x27;link_u_as.acid&#x27;</span>, <span class=\"string\">&#x27;=&#x27;</span>, <span class=\"string\">&#x27;r_activitys.acid&#x27;</span>)</span><br><span class=\"line\">        -&gt;<span class=\"title function_ invoke__\">select</span>(<span class=\"string\">&#x27;link_u_as.rid&#x27;</span>, <span class=\"string\">&#x27;link_u_as.acid&#x27;</span>, <span class=\"string\">&#x27;link_u_as.isfinished&#x27;</span>, <span class=\"string\">&#x27;r_activitys.title&#x27;</span>, <span class=\"string\">&#x27;r_activitys.distance&#x27;</span>, <span class=\"string\">&#x27;r_activitys.period&#x27;</span>, <span class=\"string\">&#x27;r_activitys.meid&#x27;</span>)</span><br><span class=\"line\">        -&gt;<span class=\"title function_ invoke__\">where</span>(<span class=\"string\">&#x27;r_activitys.period&#x27;</span>, <span class=\"string\">&#x27;&gt;&#x27;</span>, <span class=\"variable\">$timeNow</span>)  <span class=\"comment\">//有效期内的活动</span></span><br><span class=\"line\">        -&gt;<span class=\"title function_ invoke__\">where</span>(<span class=\"string\">&#x27;link_u_as.rid&#x27;</span>, <span class=\"variable\">$rid</span>)  <span class=\"comment\">//已报名的活动</span></span><br><span class=\"line\">        -&gt;<span class=\"title function_ invoke__\">where</span>(<span class=\"string\">&#x27;link_u_as.isfinished&#x27;</span>, <span class=\"number\">0</span>) <span class=\"comment\">//未完成的活动</span></span><br><span class=\"line\">        -&gt;<span class=\"title function_ invoke__\">where</span>(<span class=\"string\">&#x27;r_activitys.distance&#x27;</span>, <span class=\"string\">&#x27;&lt;=&#x27;</span>, <span class=\"variable\">$distance</span>)  <span class=\"comment\">//达到挑战条件</span></span><br><span class=\"line\">        -&gt;<span class=\"title function_ invoke__\">orderBy</span>(<span class=\"string\">&#x27;r_activitys.period&#x27;</span>, <span class=\"string\">&#x27;asc&#x27;</span>)  <span class=\"comment\">//升序</span></span><br><span class=\"line\">        -&gt;<span class=\"title function_ invoke__\">first</span>();  <span class=\"comment\">//获取最近将要过期的</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"variable\">$theLastestFinished</span>)&#123;</span><br><span class=\"line\">        <span class=\"variable\">$medal</span> = <span class=\"title class_\">RMedals</span>::<span class=\"title function_ invoke__\">where</span>(<span class=\"string\">&#x27;meid&#x27;</span>, <span class=\"variable\">$theLastestFinished</span>-&gt;meid)-&gt;<span class=\"title function_ invoke__\">first</span>();</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            DB::<span class=\"title function_ invoke__\">beginTransaction</span>();</span><br><span class=\"line\">            <span class=\"comment\">// 更新记录为已完成</span></span><br><span class=\"line\">            <span class=\"title class_\">LinkUAs</span>::<span class=\"title function_ invoke__\">where</span>(<span class=\"string\">&#x27;rid&#x27;</span>, <span class=\"variable\">$theLastestFinished</span>-&gt;rid)</span><br><span class=\"line\">                -&gt;<span class=\"title function_ invoke__\">where</span>(<span class=\"string\">&#x27;acid&#x27;</span>, <span class=\"variable\">$theLastestFinished</span>-&gt;acid)</span><br><span class=\"line\">                -&gt;<span class=\"title function_ invoke__\">update</span>([<span class=\"string\">&#x27;isfinished&#x27;</span>=&gt;<span class=\"number\">1</span>]);</span><br><span class=\"line\">            <span class=\"comment\">// 勋章授予</span></span><br><span class=\"line\">            <span class=\"variable\">$me</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">LinkUMs</span>();</span><br><span class=\"line\">            <span class=\"variable\">$me</span>-&gt;<span class=\"title function_ invoke__\">fill</span>([</span><br><span class=\"line\">                <span class=\"string\">&#x27;rid&#x27;</span> =&gt; <span class=\"variable\">$theLastestFinished</span>-&gt;rid,</span><br><span class=\"line\">                <span class=\"string\">&#x27;meid&#x27;</span> =&gt; <span class=\"variable\">$theLastestFinished</span>-&gt;meid</span><br><span class=\"line\">            ]);</span><br><span class=\"line\">            <span class=\"variable\">$me</span>-&gt;<span class=\"title function_ invoke__\">save</span>();</span><br><span class=\"line\">            DB::<span class=\"title function_ invoke__\">commit</span>();</span><br><span class=\"line\">            <span class=\"title class_\">System</span>::<span class=\"title function_ invoke__\">systemNotice</span>([</span><br><span class=\"line\">                <span class=\"string\">&#x27;to&#x27;</span> =&gt; <span class=\"variable\">$theLastestFinished</span>-&gt;rid,</span><br><span class=\"line\">                <span class=\"string\">&#x27;msg&#x27;</span> =&gt; <span class=\"string\">&quot;恭喜您挑战完成活动《&quot;</span>.<span class=\"variable\">$theLastestFinished</span>-&gt;title.<span class=\"string\">&quot;》，获得一枚勋章&lt;&quot;</span>.<span class=\"variable\">$medal</span>-&gt;name.<span class=\"string\">&quot;&gt;&quot;</span></span><br><span class=\"line\">            ]);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (\\<span class=\"built_in\">Throwable</span> <span class=\"variable\">$th</span>) &#123;</span><br><span class=\"line\">            DB::<span class=\"title function_ invoke__\">rollback</span>();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>称号等级</strong>：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 初始数据-等级称号</span></span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"variable\">$honors</span> = [<span class=\"string\">&#x27;赤脚&#x27;</span>, <span class=\"string\">&#x27;草鞋&#x27;</span>, <span class=\"string\">&#x27;棉鞋&#x27;</span>, <span class=\"string\">&#x27;布鞋&#x27;</span>, <span class=\"string\">&#x27;板鞋&#x27;</span>, <span class=\"string\">&#x27;高跟鞋&#x27;</span>, <span class=\"string\">&#x27;球鞋&#x27;</span>, <span class=\"string\">&#x27;运动鞋&#x27;</span>, <span class=\"string\">&#x27;跑鞋&#x27;</span>];</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Execute the console command.</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@return</span> mixed</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">handle</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//统计每个用户的运动次数</span></span><br><span class=\"line\">    <span class=\"variable\">$userRuns</span> = <span class=\"title class_\">RUsers</span>::<span class=\"title function_ invoke__\">join</span>(<span class=\"string\">&#x27;r_runs&#x27;</span>, <span class=\"string\">&#x27;r_users.rid&#x27;</span>, <span class=\"string\">&#x27;=&#x27;</span>, <span class=\"string\">&#x27;r_runs.rid&#x27;</span>)</span><br><span class=\"line\">        -&gt;<span class=\"title function_ invoke__\">where</span>(<span class=\"string\">&#x27;r_runs.distance&#x27;</span>, <span class=\"string\">&#x27;&lt;&gt;&#x27;</span>, <span class=\"literal\">null</span>) <span class=\"comment\">//排除未完成运动</span></span><br><span class=\"line\">        -&gt;<span class=\"title function_ invoke__\">select</span>(</span><br><span class=\"line\">        DB::<span class=\"title function_ invoke__\">raw</span>(</span><br><span class=\"line\">            <span class=\"string\">&#x27;r_users.rid, count(r_runs.ruid) as count&#x27;</span></span><br><span class=\"line\">        )</span><br><span class=\"line\">    )</span><br><span class=\"line\">        -&gt;<span class=\"title function_ invoke__\">groupBy</span>(<span class=\"string\">&#x27;r_runs.rid&#x27;</span>)</span><br><span class=\"line\">        -&gt;<span class=\"title function_ invoke__\">get</span>();</span><br><span class=\"line\">    <span class=\"keyword\">foreach</span>(<span class=\"variable\">$userRuns</span> <span class=\"keyword\">as</span> <span class=\"variable\">$user</span>)&#123;</span><br><span class=\"line\">        <span class=\"variable\">$hoid</span> = <span class=\"number\">1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"variable\">$user</span>-&gt;count &lt;= <span class=\"number\">1</span>) <span class=\"variable\">$hoid</span> = <span class=\"number\">1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(<span class=\"variable\">$user</span>-&gt;count &lt; <span class=\"number\">10</span>) <span class=\"variable\">$hoid</span> = <span class=\"number\">2</span>;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(<span class=\"variable\">$user</span>-&gt;count &lt; <span class=\"number\">50</span>) <span class=\"variable\">$hoid</span> = <span class=\"number\">3</span>;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(<span class=\"variable\">$user</span>-&gt;count &lt; <span class=\"number\">100</span>) <span class=\"variable\">$hoid</span> = <span class=\"number\">4</span>;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(<span class=\"variable\">$user</span>-&gt;count &lt; <span class=\"number\">200</span>) <span class=\"variable\">$hoid</span> = <span class=\"number\">5</span>;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(<span class=\"variable\">$user</span>-&gt;count &lt; <span class=\"number\">400</span>) <span class=\"variable\">$hoid</span> = <span class=\"number\">6</span>;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(<span class=\"variable\">$user</span>-&gt;count &lt; <span class=\"number\">800</span>) <span class=\"variable\">$hoid</span> = <span class=\"number\">7</span>;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(<span class=\"variable\">$user</span>-&gt;count &lt; <span class=\"number\">1000</span>) <span class=\"variable\">$hoid</span> = <span class=\"number\">8</span>;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"variable\">$hoid</span> = <span class=\"number\">9</span>;</span><br><span class=\"line\">        <span class=\"comment\">//先查询是否已存在相同等级的称号</span></span><br><span class=\"line\">        <span class=\"variable\">$linkHonors</span> = <span class=\"title class_\">LinkUHs</span>::<span class=\"title function_ invoke__\">where</span>(<span class=\"string\">&#x27;rid&#x27;</span>, <span class=\"variable\">$user</span>-&gt;rid)-&gt;<span class=\"title function_ invoke__\">where</span>(<span class=\"string\">&#x27;hoid&#x27;</span>, <span class=\"string\">&#x27;=&#x27;</span>, <span class=\"variable\">$hoid</span>)-&gt;<span class=\"title function_ invoke__\">first</span>();</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!<span class=\"variable\">$linkHonors</span>)&#123; <span class=\"comment\">//如果不存在，则可以进行称号进阶授予</span></span><br><span class=\"line\">            <span class=\"title class_\">LinkUHs</span>::<span class=\"title function_ invoke__\">where</span>(<span class=\"string\">&#x27;rid&#x27;</span>, <span class=\"variable\">$user</span>-&gt;rid)</span><br><span class=\"line\">                -&gt;<span class=\"title function_ invoke__\">update</span>([<span class=\"string\">&#x27;hoid&#x27;</span> =&gt; <span class=\"variable\">$hoid</span> ]);</span><br><span class=\"line\">            <span class=\"title class_\">System</span>::<span class=\"title function_ invoke__\">systemNotice</span>([</span><br><span class=\"line\">                <span class=\"string\">&#x27;to&#x27;</span> =&gt; <span class=\"variable\">$user</span>-&gt;rid,</span><br><span class=\"line\">                <span class=\"string\">&#x27;msg&#x27;</span> =&gt; <span class=\"string\">&quot;你已累计运动 <span class=\"subst\">$user</span>-&gt;count 次，授予您新的的称号: lv&quot;</span>.(<span class=\"variable\">$hoid</span>-<span class=\"number\">1</span>).<span class=\"string\">&#x27; &#x27;</span>.<span class=\"variable language_\">$this</span>-&gt;honors[<span class=\"variable\">$hoid</span>-<span class=\"number\">1</span>]</span><br><span class=\"line\">            ]);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"六、结束\">六、结束<a title=\"#六、结束\" href=\"#六、结束\"></a></h2>\n<p><strong>总结</strong>：其实写到后面我不知道怎么写了，我的目的就是想给学弟学妹们做毕设时可以参考我的过程。</p>\n<p>就大概写这些吧，</p>\n<p>烂尾了，</p>\n<p>差评！🤪</p>\n","prev":{"title":"JavaScript新特性","link":"Learning/75dfaa707e38"},"next":{"title":"JSHint的使用和配置","link":"Learning/7737c2250f76"},"plink":"https://blog.jschef.com/Learning/3029bde5b8fc/","toc":[{"id":"一、写前bb","title":"一、写前BB","index":"1"},{"id":"二、功能设计","title":"二、功能设计","index":"2"},{"id":"三、数据库设计","title":"三、数据库设计","index":"3"},{"id":"四、开发前的准备","title":"四、开发前的准备","index":"4","children":[{"id":"4.1-技术调研","title":"4.1 技术调研","index":"4.1"},{"id":"4.2-规范制定","title":"4.2 规范制定","index":"4.2"},{"id":"4.3-工具和环境","title":"4.3 工具和环境","index":"4.3"}]},{"id":"五、项目代码介绍","title":"五、项目代码介绍","index":"5","children":[{"id":"5.1-前端","title":"5.1 前端","index":"5.1"},{"id":"5.2-后端","title":"5.2 后端","index":"5.2"}]},{"id":"六、结束","title":"六、结束","index":"6"}],"reward":true,"copyright":{"author":"Chef Wu","link":"<a href=\"https://blog.jschef.com/Learning/3029bde5b8fc/\" title=\"毕业设计-“跑鸭”微信小程序\">https://blog.jschef.com/Learning/3029bde5b8fc/</a>","license":"自由转载-非商用-禁止演绎-保持署名 (<a href=\\\"https://creativecommons.org/licenses/by-nc-sa/4.0/\\\" rel=\\\"external nofollow\\\" target=\\\"_blank\\\">CC BY-NC-ND 4.0</a>)","published":"June 17, 2020"}}